{% load static %}
{% load inventory_extras %}
<!DOCTYPE html>
<html lang="en" data-user-auth="{% if user.is_authenticated %}1{% else %}0{% endif %}" data-cookie-theme="{{ request.COOKIES.theme|default_if_none:'' }}" data-bs-theme="{{ request.COOKIES.theme|default_if_none:'' }}">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{% block title %}BlockShelf{% endblock %}</title>
  <script>
    // Apply theme ASAP to avoid FOUC (flash of unthemed content)
    (function () {
      try {
        var key = 'ui.theme';
        // Try localStorage first, then server-rendered data-bs-theme, else system
        var theme = localStorage.getItem(key) ||
                    (document.documentElement.getAttribute('data-bs-theme') || '').trim();
        if (!theme) {
          theme = (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches)
            ? 'dark' : 'light';
        }
        document.documentElement.setAttribute('data-theme', theme);
        document.documentElement.setAttribute('data-bs-theme', theme);
      } catch (e) { /* no-op */ }
    })();
  </script>

  <!-- Bootstrap 5 (for forms/buttons/layout) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
  <!-- Your app styles -->
  <link rel="stylesheet" href="{% static 'css/app.css' %}">
  <link rel="stylesheet" href="{% static 'css/tweaks.css' %}">
  <link rel="stylesheet" href="{% static 'css/styles.css' %}">
</head>
<body>
  <!-- Skip to main content link for keyboard navigation -->
  <a href="#main-content" class="skip-link sr-only sr-only-focusable">Skip to main content</a>

  <div class="app-shell">
    <aside class="app-sidebar" id="sidebar" role="complementary" aria-label="Main navigation sidebar">
      <div class="brand">
        <img src="{% static 'img/logo-blocks.png' %}" alt="BlockShelf logo" width="200" height="200">
        <!-- <span class="name">BlockShelf</span> -->
      </div>
      <nav aria-label="Primary navigation">
        <ul class="app-nav" role="list">
          {% if user.is_authenticated %}
            <li><a href="{% url 'inventory:list' %}" class="{% if request.resolver_match.url_name in 'list' %}active{% endif %}">üì¶ Inventory</a></li>
            <li><a href="{% url 'inventory:add' %}" class="{% if request.resolver_match.url_name in 'add' %}active{% endif %}">‚ûï Add Item</a></li>
            <li><a href="{% url 'inventory:notes_list' %}" class="{% if 'note' in request.resolver_match.url_name %}active{% endif %}">üìù Notes</a></li>
            <li><a href="{% url 'inventory:settings' %}" class="{% if request.resolver_match.url_name in 'settings' %}active{% endif %}">‚öôÔ∏è Settings</a></li>
          {% else %}
            {% if request.resolver_match.url_name != 'login' and request.resolver_match.url_name != 'account_login' and request.resolver_match.url_name != 'account_signup' %}
              <li><a href="{% url 'login' %}">üîê Login</a></li>
              <li><a href="{% url 'account_signup' %}">‚ú≥Ô∏è Sign up</a></li>
            {% endif %}
          {% endif %}
        </ul>
      </nav>
      {% if user.is_authenticated %}
      <div class="app-user">
        <span>Hi, {{ user.username }}!</span>
      </div>
      {% endif %}
    </aside>

	<main class="app-main" id="main-content" role="main" tabindex="-1">
	  <header class="app-topbar d-flex align-items-center justify-content-between" role="banner">
		<div class="d-flex align-items-center gap-2">
		</div>
		<div class="d-flex align-items-center gap-2">
		  <button id="themeToggle" class="btn btn-outline" type="button" aria-label="Toggle dark/light theme">üåì</button>

		  {% if user.is_authenticated %}
			<form action="{% url 'logout' %}" method="post" class="m-0 p-0 d-inline">
			  {% csrf_token %}
			  {# optional next redirect; safe to omit since LOGOUT_REDIRECT_URL is set #}
			  {# <input type="hidden" name="next" value="{% url 'login' %}"> #}
			  <button type="submit" class="btn btn-outline">Logout</button>
			</form>
		  {% else %}
		    {% if request.resolver_match and request.resolver_match.url_name != 'login' and request.resolver_match.url_name != 'account_login' and request.resolver_match.url_name != 'account_signup' %}
		    	<a class="btn btn-outline" href="{% url 'login' %}">Login</a>
		    {% endif %}
		  {% endif %}

		</div>
	  </header>


      <section class="app-content container-fluid py-4">
        {% block content %}{% endblock %}
      </section>
    </main>
  </div>

  <!-- Accessibility and Validation Scripts -->
  <script src="{% static 'js/accessibility.js' %}"></script>
  <script src="{% static 'js/validation.js' %}"></script>

  {% block scripts %}{% endblock %}
  <!-- Bootstrap JS (optional; components) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

  <script>
  // Sidebar toggle
  document.getElementById('sidebarToggle')?.addEventListener('click', ()=>{
    document.getElementById('sidebar')?.classList.toggle('is-open');
  });

  // THEME SCRIPT (no DB lookup; cookie/localStorage/system only)
  (function(){
    const key = 'ui.theme';
    const getSystem = () => window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    const html = document.documentElement;
    const cookieTheme = html.getAttribute('data-cookie-theme') || '';
    const saved = localStorage.getItem(key);
    const initial = saved || cookieTheme || getSystem();
    const apply = (t) => {html.setAttribute('data-theme', t); html.setAttribute('data-bs-theme', t);};
    apply(initial);

    function getCookie(name){
      const m = document.cookie.match('(?:^|;)\s*' + name + '=([^;]*)');
      return m ? decodeURIComponent(m[1]) : '';
    }

    const btn = document.getElementById('themeToggle');
    if(btn){
      btn.addEventListener('click', function(){
        const current = html.getAttribute('data-theme') || getSystem();
        const next = current === 'dark' ? 'light' : 'dark';
        apply(next);
        localStorage.setItem(key, next);
        // also set a cookie for server-side awareness
        document.cookie = 'theme=' + encodeURIComponent(next) + ';path=/;max-age=' + (60*60*24*365);
        // Optional: POST to persist later when DB model exists
        // fetch("{% url 'inventory:set_theme' %}", { method:'POST', headers:{'X-CSRFToken': getCookie('csrftoken')}, body: new URLSearchParams({theme: next}) });
      });
    }
    const mq = window.matchMedia('(prefers-color-scheme: dark)');
    if (mq.addEventListener) {
      mq.addEventListener('change', e => {
        const stored = localStorage.getItem(key);
        if(!stored){ apply(e.matches ? 'dark':'light'); }
      });
    }
  })();
  </script>
</body>
</html>